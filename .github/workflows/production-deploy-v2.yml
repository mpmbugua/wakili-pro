name: ðŸš€ Production Deployment Pipeline v2
on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'shared/**'
      - '.github/workflows/production-deploy-v2.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_deploy:
        description: 'Force deployment (bypass quality gates)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

# ================================
# VALIDATION STAGE
# ================================
jobs:
  validate:
    name: ðŸ” Quality Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ”§ Installing root workspace dependencies..."
          npm ci --ignore-scripts
          
          echo "ðŸ“¦ Installing frontend dependencies..."
          cd frontend
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "âš ï¸ No package-lock.json found, running npm install..."
            npm install
          fi
          cd ..
          
          echo "ðŸ“¦ Installing shared dependencies..."  
          cd shared
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "âš ï¸ No package-lock.json found, running npm install..."
            npm install
          fi
          cd ..
          
          echo "âœ… All dependencies installed successfully"

      - name: ðŸ—ï¸ Build Shared Package
        working-directory: ./shared
        run: npm run build

      - name: ðŸŽ¨ ESLint Analysis
        working-directory: ./frontend
        run: npm run lint

      - name: ðŸ” TypeScript Check
        working-directory: ./frontend
        run: npm run type-check

      - name: ðŸ§ª Run Tests
        working-directory: ./frontend
        run: npm test -- --run --reporter=verbose

  # ================================
  # BUILD STAGE
  # ================================
  build:
    name: ðŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            echo "ðŸ“¦ Installing locked dependencies..."
            npm ci
          else
            echo "âš ï¸ No package-lock.json found, running npm install..."
            npm install
          fi

      - name: ðŸ”§ Configure Production Environment
        working-directory: ./frontend
        run: |
          cat > .env.production << EOF
          VITE_API_URL=https://wakili-pro.onrender.com/api
          VITE_APP_NAME=Wakili Pro
          VITE_APP_VERSION=2.0.0
          VITE_ENVIRONMENT=production
          VITE_ENABLE_AI_ASSISTANT=true
          VITE_ENABLE_VIDEO_CALLS=true
          VITE_ENABLE_PAYMENTS=true
          VITE_BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VITE_BUILD_COMMIT=${{ github.sha }}
          EOF

      - name: ðŸ—ï¸ Build Production Application
        working-directory: ./frontend
        run: |
          npm run build
          echo "ðŸ“Š Build completed:"
          du -sh dist/
          ls -la dist/

      - name: ðŸ§ª Validate Build Output
        working-directory: ./frontend
        run: |
          test -f dist/index.html || { echo "âŒ Missing index.html"; exit 1; }
          test -d dist/assets || { echo "âŒ Missing assets"; exit 1; }
          echo "âœ… Build validation passed"

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-v2
          path: frontend/dist/
          retention-days: 7

  # ================================
  # DEPLOYMENT STAGE
  # ================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, build]
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-v2
          path: ./artifacts/

      - name: ðŸ—ï¸ Create Deployment Package
        run: |
          echo "ðŸ—ï¸ Creating deployment package..."
          
          # Create deployment workspace
          mkdir -p deployment-package
          
          # Copy build artifacts to deployment root
          echo "ðŸ“¦ Copying build artifacts..."
          cp -r ./artifacts/* ./deployment-package/
          
          # Create optimized Vercel configuration
          echo "ðŸ”§ Creating deployment configuration..."
          cat > ./deployment-package/vercel.json << 'EOF'
          {
            "version": 2,
            "framework": null,
            "buildCommand": "echo 'Pre-built application'",
            "outputDirectory": ".",
            "routes": [
              {
                "src": "/assets/(.*)",
                "headers": {
                  "Cache-Control": "public, max-age=31536000, immutable"
                }
              },
              {
                "src": "/(.*)",
                "dest": "/index.html"
              }
            ],
            "headers": [
              {
                "source": "/(.*)",
                "headers": [
                  {
                    "key": "X-Content-Type-Options",
                    "value": "nosniff"
                  },
                  {
                    "key": "X-Frame-Options",
                    "value": "DENY"
                  },
                  {
                    "key": "X-XSS-Protection",
                    "value": "1; mode=block"
                  }
                ]
              }
            ]
          }
          EOF
          
          # Verify deployment package
          echo "âœ… Deployment package created:"
          ls -la ./deployment-package/
          du -sh ./deployment-package/

      - name: ðŸš€ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ðŸŒ Deploy to Vercel
        working-directory: ./deployment-package
        run: |
          echo "ðŸŒ Starting production deployment..."
          
          # Deploy with clean configuration
          vercel deploy \
            --prod \
            --token="${{ env.VERCEL_TOKEN }}" \
            --yes \
            --name="wakili-pro" \
            --scope="${{ env.VERCEL_ORG_ID }}" > deployment-output.txt 2>&1
          
          # Extract deployment URL
          DEPLOYMENT_URL=$(grep -o 'https://[^[:space:]]*\.vercel\.app' deployment-output.txt | head -1)
          
          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âŒ Deployment failed"
            cat deployment-output.txt
            exit 1
          fi
          
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Production URL: $DEPLOYMENT_URL"
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV

      - name: ðŸ§ª Production Health Check
        run: |
          echo "ðŸ§ª Running production health checks..."
          
          # Wait for deployment to be ready
          sleep 45
          
          # Test deployment
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Production deployment health check passed"
          else
            echo "âŒ Health check failed: HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [$DEPLOYMENT_URL]($DEPLOYMENT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: [wakili-pro.onrender.com](https://wakili-pro.onrender.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. **Test Authentication**: Verify login/register functionality" >> $GITHUB_STEP_SUMMARY
          echo "2. **Backend Connectivity**: Confirm API integration" >> $GITHUB_STEP_SUMMARY
          echo "3. **User Acceptance**: Monitor application performance" >> $GITHUB_STEP_SUMMARY

  # ================================
  # CLEANUP STAGE
  # ================================
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [validate, build, deploy]
    if: always()
    
    steps:
      - name: ðŸ“Š Pipeline Status Report
        run: |
          echo "ðŸ“Š Pipeline Execution Summary:"
          echo "- Validation: ${{ needs.validate.result }}"
          echo "- Build: ${{ needs.build.result }}"
          echo "- Deploy: ${{ needs.deploy.result }}"